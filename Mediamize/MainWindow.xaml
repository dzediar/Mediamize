<zw:zSmoothWindow x:Class="Mediamize.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:i="clr-namespace:Microsoft.Xaml.Behaviors;assembly=Microsoft.Xaml.Behaviors"
        xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
        xmlns:converters="clr-namespace:zComp.Wpf.Converters;assembly=zComp.Wpf"
        xmlns:view="clr-namespace:Mediamize.View"                  
        xmlns:viewModel="clr-namespace:zComp.Wpf.ViewModel;assembly=zComp.Wpf"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        xmlns:zw="clr-namespace:zComp.Wpf;assembly=zComp.Wpf"
        xmlns:zwModel="clr-namespace:zComp.Wpf.Model;assembly=zComp.Wpf"    
        xmlns:zwView="clr-namespace:zComp.Wpf.View;assembly=zComp.Wpf"
        xmlns:zwbehaviors="clr-namespace:zComp.Wpf.Behaviors;assembly=zComp.Wpf"
        MinWidth="1200" MinHeight="800" Width="1200" Height="800"
        WindowStartupLocation="CenterScreen"
        WindowState="{Binding Repository.LocalConfiguration.MainWindowState, Mode=TwoWay, Converter={x:Static converters:zWindowStateToStringConverter.Instance}}"
        Title="{Binding ApplicationTitle, Mode=OneWay, Source={x:Static viewModel:ApplicationViewModel.Instance}}">
    <zw:zSmoothWindow.Resources>
        
        <CollectionViewSource x:Key="AvailableFormats" Source="{Binding AvailableFormats, Mode=OneWay}"
                              zw:zFrameworkElementExtension.FilterFields="Ext,Resolution,Note,FormatType,Description">
            <CollectionViewSource.SortDescriptions>
                <scm:SortDescription PropertyName="FormatType" Direction="Ascending"/>
                <!--<scm:SortDescription PropertyName="DisplayName" Direction="Ascending"/>-->
            </CollectionViewSource.SortDescriptions>
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="FormatType" />
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>

    </zw:zSmoothWindow.Resources>
    
    <zw:zGrid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <zw:zGrid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
            <zw:zGrid.RowDefinitions>
                <RowDefinition Height="*" MinHeight="300"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="300" MinHeight="300"/>
            </zw:zGrid.RowDefinitions>

            <MediaElement x:Name="mediaElement" Visibility="Collapsed" LoadedBehavior="Play" MediaOpened="MediaElement_MediaOpened"
                          Source="{Binding SoundToPlay, Mode=OneWay, Source={x:Static viewModel:ApplicationViewModel.Instance}}"/>

            <zw:zTabGroupBox Grid.Row="0" IsExpandable="False" IsExpanded="True" BorderThickness="0 0.5 0 0" FrameWidth="0" Padding="0"
                             FrameBackground="{DynamicResource {x:Static zw:zCompColors.DefaultGradientBackgroundReverseBrushKey}}">
                <zw:zTabGroupBox.Header>
                    <zw:zGrid Margin="4">
                        <zw:zGrid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </zw:zGrid.ColumnDefinitions>

                        <zw:zStackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top">

                            <zw:zButton x:Name="btBack" Style="{StaticResource {x:Static zw:zCompRepository.CircleButtonStyleKey}}"
                                        zwView:Translator.ToolTip="URL_BACK" Width="30" Height="30" ContentTemplateSelector="{x:Null}"
                                        Margin="0 0 8 0" HorizontalAlignment="Left" VerticalAlignment="Top" ContentTemplate="{StaticResource BackIcon}" Content="1"
                                        IsEnabled="{Binding WebView.CanGoBack, Mode=OneWay, ElementName=webView, FallbackValue=false, TargetNullValue=false}" Click="btBack_Click"/>
                            
                        </zw:zStackPanel>

                        <zw:zTextBox Grid.Column="1" Text="{Binding CurrentUrl, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Delay=800}" 
                                     Margin="-4 0 4 0" HorizontalAlignment="Stretch" FontSize="16">
                            <zw:zTextBox.InputBindings>
                                <KeyBinding Key="Return" Command="{Binding AnalyzeUrlCommand, Mode=OneTime}"/>
                            </zw:zTextBox.InputBindings>
                        </zw:zTextBox>

                        <zw:zStackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top">

                            <zw:zButton Style="{StaticResource {x:Static zw:zCompRepository.CircleButtonStyleKey}}"
                                        zwView:Translator.ToolTip="OPEN_SETTINGS" Width="30" Height="30" ContentTemplateSelector="{x:Null}"
                                        Margin="8 0 0 0" HorizontalAlignment="Left" VerticalAlignment="Top" ContentTemplate="{StaticResource UserSkillGearIcon}" Content="1"
                                        Command="{Binding OpenSettingsCommand, Mode=OneTime}"/>

                            <zw:zComboBox SelectedValuePath="Key" DisplayMemberPath="Value.CultureName" HorizontalAlignment="Center" 
                                          Margin="8 0 0 0" Width="40" BorderThickness="1" VerticalContentAlignment="Center"
                                          SelectedValue="{Binding Repository.CurrentCulture, Mode=TwoWay}"
                                          ItemsSource="{Binding Repository.ManagedCultures, Mode=OneWay}"/>

                        </zw:zStackPanel>
                    </zw:zGrid>
                </zw:zTabGroupBox.Header>
                <zw:zBorder BorderThickness="0 0.5 0 0" Margin="0">
                    <!--
                    <wv2:WebView2 x:Name="webView" Margin="0" Source="{Binding BrowsedUrl, Mode=TwoWay}"/>
                    -->
                    <view:EnhancedWebBrowser x:Name="webView" Margin="0" Source="{Binding BrowsedUrl, Mode=TwoWay}"/>
                </zw:zBorder>
            </zw:zTabGroupBox>

            <GridSplitter Grid.Row="1" HorizontalAlignment="Stretch" Height="4"/>

            <!-- Bottom Panel -->
            <zw:zGrid Grid.Row="2">
                
                <zw:zGrid.ColumnDefinitions>
                    <ColumnDefinition Width="0.5*"/>
                    <ColumnDefinition Width="0.5*"/>
                </zw:zGrid.ColumnDefinitions>

                <!-- Format List -->
                <zw:zTabGroupBox Grid.Column="0" BorderThickness="0 0.5 0 0" Margin="0 -2 0 0" InnerBorderThickness="0 0.5 0 0.5" FrameWidth="0" Padding="0">
                    <zw:zTabGroupBox.Header>
                    
                        <zw:zGrid Margin="4">
                        
                            <zw:zGrid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </zw:zGrid.ColumnDefinitions>

                            <ProgressBar Grid.ColumnSpan="3" HorizontalAlignment="Stretch" VerticalAlignment="Top" 
                                         Height="3" Margin="-8 -8 -8 0" Padding="0" BorderThickness="0" Background="Transparent"
                                         Minimum="0" Maximum="100" Value="{Binding AnalyzingUrlTempo, FallbackValue=0, TargetNullValue=0, Mode=OneWay}" 
                                         Visibility="{Binding AnalyzingUrlTempo, Mode=OneWay, Converter={x:Static converters:zObjectToVisibilityConverter.Instance}}"/>

                            <Ellipse Grid.Column="0" Style="{StaticResource {x:Static zw:zCompRepository.LoadingEllipseStyleKey}}" 
                                     StrokeThickness="3" Width="20" Height="20" Margin="0 0 8 0" IsHitTestVisible="False" VerticalAlignment="Center"
                                     Visibility="{Binding IsAnalyzingUrl, Mode=OneWay, Converter={x:Static converters:zBoolToVisibilityConverter.Instance}}"/>

                            <zw:zTextBlock Grid.Column="1" zwView:Translator.Text="AVAILABLE_FORMATS" FontSize="16" Margin="0"/>

                            <!-- Actions -->
                            <zw:zStackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">

                                <zw:zTextBox x:Name="edFilter" Grid.Row="0" Style="{StaticResource SearchTextBox}" 
                                             zw:zFrameworkElementExtension.FilterText="{Binding RelativeSource={RelativeSource Self}, Path=Text, Mode=TwoWay, Delay=600}"
                                             zw:zFrameworkElementExtension.FilterTarget="{Binding Source={StaticResource AvailableFormats}}"
                                             zw:zFrameworkElementExtension.FilterFields="Ext,Resolution,Note,FormatType,Description"
                                             Margin="0 0 4 0" Padding="4" TextAlignment="Left" Background="Transparent" FontSize="16"
                                             VerticalAlignment="Center" HorizontalAlignment="Right" Width="200" BorderThickness="0.5"/>

                                <zw:zButton Grid.Column="1" Style="{StaticResource {x:Static zw:zCompRepository.CircleButtonStyleKey}}"
                                            zwView:Translator.ToolTip="ADD_EXTRACTION_TO_QUEUE" Width="30" Height="30" ContentTemplateSelector="{x:Null}"
                                            Margin="0 0 8 0" HorizontalAlignment="Left" VerticalAlignment="Top" ContentTemplate="{StaticResource AddIcon}" Content="1"
                                            Command="{Binding AddJobCommand, Mode=OneTime}"/>

                                <zw:zButton Grid.Column="1" Style="{StaticResource {x:Static zw:zCompRepository.CircleButtonStyleKey}}"
                                            zwView:Translator.ToolTip="ADD_PLAYLIST_TO_QUEUE" Width="30" Height="30" ContentTemplateSelector="{x:Null}"
                                            Margin="0 0 0 0" HorizontalAlignment="Left" VerticalAlignment="Top" ContentTemplate="{StaticResource AddManyIcon}" Content="1"
                                            Command="{Binding AddPlaylistCommand, Mode=OneTime}"/>                                
                           
                            </zw:zStackPanel>

                        </zw:zGrid>
                    </zw:zTabGroupBox.Header>
                    <zw:zListBox x:Name="lbAvailableFormats" BorderThickness="0" ShowGroupsHeaders="True" Padding="0" Margin="0"
                                 VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.ScrollUnit="Pixel" ScrollViewer.CanContentScroll="False" 
                                 SelectedItem="{Binding SelectedFormat}" ItemsSource="{Binding Source={StaticResource AvailableFormats}}">
                        <!--
                        <i:Interaction.Behaviors>
                            <zwbehaviors:zItemsControlFilterBehavior FilterValue="{Binding Text, Mode=OneWay, ElementName=edFilter}" FilterDelay="00:00:00.600"
                                ItemsSource="{Binding Source={StaticResource AvailableFormats}}" 
                                FieldsList="Ext,Resolution,Note,FormatType,Description"/>
                        </i:Interaction.Behaviors>
                        -->
                        <zw:zListBox.ItemTemplate>
                            <DataTemplate>
                                <zw:zTextBlock>
                                    <Run Text="{Binding Format, Mode=OneTime}" FontWeight="Bold"/>
                                    <LineBreak/>
                                    <Run Text="{Binding Description, Mode=OneTime}" FontSize="10"/>
                                </zw:zTextBlock>
                            </DataTemplate>
                        </zw:zListBox.ItemTemplate>
                    </zw:zListBox>
                </zw:zTabGroupBox>

                <!-- Job Queue -->
                <zw:zTabGroupBox Grid.Column="1" Margin="0 -2 0 0" BorderThickness="0.5 0.5 0 0.5" InnerBorderThickness="0 0.5 0 0" FrameWidth="0" Padding="0">
                    <zw:zTabGroupBox.Header>

                        <zw:zGrid Margin="4">

                            <zw:zGrid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </zw:zGrid.ColumnDefinitions>

                            <zw:zTextBlock Grid.Column="0" HorizontalAlignment="Left" VerticalAlignment="Center" zwView:Translator.Text="QUEUE" FontSize="16" Margin="0"/>

                            <zw:zTextBlock Grid.Column="0" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16" Margin="0">
                                <Run Text="{Binding Jobs.Count, Mode=OneWay}"/>
                                <Run zwView:Translator.Text3="ELEMENT(S)"/> 
                            </zw:zTextBlock>

                            <!-- Actions -->
                            <zw:zStackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                <zw:zButton Grid.Column="1" Style="{StaticResource {x:Static zw:zCompRepository.CircleButtonStyleKey}}"
                                            zwView:Translator.ToolTip="REMOVE_EXTRACTION_FROM_QUEUE" Width="30" Height="30" ContentTemplateSelector="{x:Null}"
                                            Margin="0 0 8 0" HorizontalAlignment="Left" VerticalAlignment="Top" ContentTemplate="{StaticResource Remove}" Content="1"
                                            Command="{Binding RemoveJobCommand, Mode=OneTime}"/>
                                <zw:zButton Grid.Row="3" Style="{StaticResource {x:Static zw:zCompRepository.CircleButtonStyleKey}}"
                                            zwView:Translator.ToolTip="EXTRACT" Margin="0 0 0 0" HorizontalAlignment="Left" VerticalAlignment="Top" 
                                            ContentTemplate="{StaticResource StartIcon}" Content="1" FontSize="16" Height="30"
                                            Command="{Binding StartBatchCommand, Mode=OneTime}"/>
                                <!--zwView:Translator.Caption="EXTRACT" -->
                            </zw:zStackPanel>

                        </zw:zGrid>
                    </zw:zTabGroupBox.Header>
                    <zw:zListBox VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.ScrollUnit="Pixel" ScrollViewer.CanContentScroll="False"
                                 ItemsSource="{Binding Jobs}" SelectedItem="{Binding SelectedJob}" BorderThickness="0" Margin="0" Padding="0">
                        <zw:zListBox.ItemTemplate>
                            <DataTemplate>
                                <zw:zStackPanel Orientation="Horizontal" Margin="8">
                                    <zw:zTextBlock Text="{Binding Url}" FontWeight="Bold" Margin="0"/>
                                    <zw:zTextBlock Text=" -> " Margin="0"/>
                                    <zw:zTextBlock Text="{Binding SelectedFormat.DisplayName}" Foreground="Gray" Margin="0"/>
                                </zw:zStackPanel>
                            </DataTemplate>
                        </zw:zListBox.ItemTemplate>
                    </zw:zListBox>
                </zw:zTabGroupBox>
            </zw:zGrid>
            

        </zw:zGrid>

        <ItemsControl x:Name="popupPresenter" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                        Visibility="{Binding ActivePopup, Mode=OneWay, Converter={x:Static converters:zObjectToVisibilityConverter.Instance}}"
                        ItemTemplate="{StaticResource PopupPresenter}" ItemsSource="{Binding Popups, Mode=OneWay}"
                        IsHitTestVisible="{Binding CurrentDialog, Mode=OneWay, ElementName=dialogPresenter, Converter={x:Static converters:zObjectToBoolConverter.Instance}, ConverterParameter=1}"
                        IsTabStop="{Binding CurrentDialog, Mode=OneWay, ElementName=dialogPresenter, Converter={x:Static converters:zObjectToBoolConverter.Instance}, ConverterParameter=1}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <Grid/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
        </ItemsControl>

        <zw:zMetroDialogBoxPresenter x:Name="dialogPresenter" IsVisibleChanged="DialogPresenter_IsVisibleChanged"/>

    </zw:zGrid>
</zw:zSmoothWindow>  